<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Admin Dashboard - RTB Planner</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: #f1f5f9;
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        .sidebar h1 {
            padding: 0 1.5rem;
            font-size: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .nav-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-left: 3px solid transparent;
        }
        .nav-item:hover {
            background: rgba(255,255,255,0.1);
            border-left-color: #6366f1;
        }
        .nav-item.active {
            background: rgba(99,102,241,0.2);
            border-left-color: #6366f1;
        }
        .main-content {
            margin-left: 260px;
            flex: 1;
            padding: 2rem;
        }
        .header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-card h3 {
            color: #64748b;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
        }
        .card {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .card h2 {
            color: #1e293b;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .user-item {
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            flex: 1;
        }
        .user-id {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        .user-stats {
            font-size: 0.875rem;
            color: #64748b;
        }
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .package-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .package {
            padding: 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .package:hover {
            transform: translateY(-2px);
        }
        .package.selected {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99,102,241,0.1);
        }
        .package-name {
            font-weight: 700;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }
        .package-details {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        .notification-form {
            display: grid;
            gap: 1rem;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .form-group label {
            font-weight: 600;
            color: #1e293b;
        }
        .form-group input, .form-group textarea, .form-group select {
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-family: inherit;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
        }
        .alert.success {
            background: #dcfce7;
            color: #166534;
        }
        .alert.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .alert.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1><i class="fas fa-shield-alt"></i> Admin</h1>
        <div class="nav-item active" onclick="showSection('dashboard')">
            <i class="fas fa-chart-line"></i> Dashboard
        </div>
        <div class="nav-item" onclick="showSection('users')">
            <i class="fas fa-users"></i> User Management
        </div>
        <div class="nav-item" onclick="showSection('activate')">
            <i class="fas fa-user-check"></i> Activate User
        </div>
        <div class="nav-item" onclick="showSection('notifications')">
            <i class="fas fa-bell"></i> Send Notification
        </div>
        <div class="nav-item" onclick="showSection('settings')">
            <i class="fas fa-cog"></i> System Settings
        </div>
    </div>

    <div class="main-content">
        <div class="header">
            <div>
                <h2>Admin Dashboard</h2>
                <p style="color: #64748b; font-size: 0.875rem;">Manage RTB Document Planner System</p>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <span style="color: #64748b;" id="adminName"><i class="fas fa-user-shield"></i> Administrator</span>
                <button onclick="logoutUser()" style="padding: 0.5rem 1rem; background: #ef4444; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3><i class="fas fa-users"></i> Total Users</h3>
                    <div class="value" id="totalUsers">0</div>
                </div>
                <div class="stat-card">
                    <h3><i class="fas fa-crown"></i> Premium Users</h3>
                    <div class="value" id="premiumUsers">0</div>
                </div>
                <div class="stat-card">
                    <h3><i class="fas fa-file-alt"></i> Session Plans</h3>
                    <div class="value" id="totalSessionPlans">0</div>
                </div>
                <div class="stat-card">
                    <h3><i class="fas fa-book"></i> Schemes Created</h3>
                    <div class="value" id="totalSchemes">0</div>
                </div>
            </div>

            <div class="card">
                <h2><i class="fas fa-chart-bar"></i> Quick Actions</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <button class="btn btn-primary" onclick="showSection('activate')">
                        <i class="fas fa-user-plus"></i> Activate User
                    </button>
                    <button class="btn btn-success" onclick="showSection('notifications')">
                        <i class="fas fa-paper-plane"></i> Send Notification
                    </button>
                    <button class="btn btn-primary" onclick="refreshStats()">
                        <i class="fas fa-sync"></i> Refresh Stats
                    </button>
                </div>
            </div>
        </div>

        <!-- Users Section -->
        <div id="users" class="section">
            <div class="card">
                <h2><i class="fas fa-users"></i> All Registered Users</h2>
                <div style="margin-bottom: 1rem; padding: 1rem; background: #f1f5f9; border-radius: 0.5rem;">
                    <input type="text" id="searchUser" placeholder="🔍 Search by name, phone, or institution..." style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: 1rem;" oninput="filterUsers()">
                </div>
                <div class="user-list" id="userList">
                    <p style="color: #64748b; text-align: center; padding: 2rem;">Loading users...</p>
                </div>
            </div>
        </div>

        <!-- Activate User Section -->
        <div id="activate" class="section">
            <div class="card">
                <h2><i class="fas fa-user-check"></i> Activate User Access</h2>
                <div class="alert" id="activateAlert"></div>
                
                <div class="form-group">
                    <label>Select User</label>
                    <select id="userSelect" style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: 1rem;">
                        <option value="">-- Select a user --</option>
                    </select>
                </div>
                <div id="selectedUserInfo" style="display: none; padding: 1rem; background: #f1f5f9; border-radius: 0.5rem; margin-bottom: 1rem;">
                    <strong>Selected User:</strong>
                    <div id="userInfoDisplay" style="margin-top: 0.5rem; font-size: 0.875rem; color: #64748b;"></div>
                </div>

                <h3 style="margin: 1.5rem 0 1rem;">Select Package</h3>
                <div class="package-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="package" style="background: linear-gradient(135deg, #10b981, #059669); color: white;" onclick="selectPackage(36, 1, 0)">
                        <div class="package-name">36 RWF</div>
                        <div class="package-details">1 Session Plan</div>
                    </div>
                    <div class="package" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;" onclick="selectPackage(47, 0, 1)">
                        <div class="package-name">47 RWF</div>
                        <div class="package-details">1 Scheme of Work</div>
                    </div>
                    <div class="package" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white;" onclick="selectPackage(474, 15, 0)">
                        <div class="package-name">474 RWF</div>
                        <div class="package-details">15 Session Plans (Weekly)</div>
                    </div>
                    <div class="package" style="background: linear-gradient(135deg, #ec4899, #db2777); color: white;" onclick="selectPackage(526, 0, 10)">
                        <div class="package-name">526 RWF</div>
                        <div class="package-details">10 Schemes (Weekly)</div>
                    </div>
                    <div class="package" style="background: linear-gradient(135deg, #06b6d4, #0891b2); color: white;" onclick="selectPackage(1000, 50, 0)">
                        <div class="package-name">1,000 RWF</div>
                        <div class="package-details">50 Session Plans (Monthly)</div>
                    </div>
                    <div class="package" style="background: linear-gradient(135deg, #84cc16, #65a30d); color: white;" onclick="selectPackage(1889, 0, 20)">
                        <div class="package-name">1,889 RWF</div>
                        <div class="package-details">20 Schemes (Monthly)</div>
                    </div>
                    <div class="package" style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;" onclick="selectPackage(5200, 'unlimited', 'unlimited')">
                        <div class="package-name">5,200 RWF</div>
                        <div class="package-details">Unlimited + Support (School Year)</div>
                    </div>
                </div>

                <button class="btn btn-success" style="width: 100%; padding: 1rem; font-size: 1rem;" onclick="activateUserAccess()">
                    <i class="fas fa-check-circle"></i> Activate & Send Notification
                </button>
            </div>
        </div>

        <!-- Notifications Section -->
        <div id="notifications" class="section">
            <div class="card">
                <h2><i class="fas fa-bell"></i> Send In-App Notification</h2>
                <div class="alert" id="notificationAlert"></div>
                
                <form class="notification-form" onsubmit="sendNotification(event)">
                    <div class="form-group">
                        <label>Notification Template</label>
                        <select id="notificationType" onchange="loadNotificationTemplate()">
                            <option value="custom">Custom Message</option>
                            <option value="payment">Payment Confirmation</option>
                            <option value="welcome">Welcome Message</option>
                            <option value="session_plan">Session Plan Ready</option>
                            <option value="scheme_ready">Scheme of Work Ready</option>
                            <option value="subscription">Subscription Update</option>
                            <option value="reminder">Payment Reminder</option>
                            <option value="announcement">System Announcement</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Send To</label>
                        <select id="notifUserSelect" style="padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 0.5rem; font-size: 1rem;">
                            <option value="">All Users (Broadcast)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Message Title</label>
                        <input type="text" id="notifTitle" placeholder="e.g., Payment Received" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Message Content</label>
                        <textarea id="notifMessage" placeholder="Your notification message..." required></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success" style="width: 100%; padding: 1rem;">
                        <i class="fas fa-paper-plane"></i> Send Notification
                    </button>
                </form>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <div class="card">
                <h2><i class="fas fa-cog"></i> System Settings</h2>
                <div class="alert" id="settingsAlert"></div>
                
                <h3 style="margin-bottom: 1rem; color: #1e293b;">Free Download Limits</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem;">
                    <div class="form-group">
                        <label>Free Session Plans</label>
                        <input type="number" id="freeSessionPlans" min="0" max="10">
                    </div>
                    <div class="form-group">
                        <label>Free Schemes</label>
                        <input type="number" id="freeSchemes" min="0" max="10">
                    </div>
                </div>
                
                <h3 style="margin-bottom: 1rem; color: #1e293b;">Subscription Pricing (RWF)</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem;">
                    <div class="form-group">
                        <label>Per Session Plan</label>
                        <input type="number" id="perSessionPrice" min="10" step="1">
                    </div>
                    <div class="form-group">
                        <label>Per Scheme</label>
                        <input type="number" id="perSchemePrice" min="10" step="1">
                    </div>
                    <div class="form-group">
                        <label>Weekly Sessions (15 plans)</label>
                        <input type="number" id="weeklySessionsPrice" min="100" step="10">
                    </div>
                    <div class="form-group">
                        <label>Weekly Schemes (10 schemes)</label>
                        <input type="number" id="weeklySchemesPrice" min="100" step="10">
                    </div>
                    <div class="form-group">
                        <label>Monthly Sessions (50 plans)</label>
                        <input type="number" id="monthlySessionsPrice" min="500" step="50">
                    </div>
                    <div class="form-group">
                        <label>Monthly Schemes (20 schemes)</label>
                        <input type="number" id="monthlySchemesPrice" min="500" step="50">
                    </div>
                    <div class="form-group">
                        <label>School Year Unlimited</label>
                        <input type="number" id="unlimitedPrice" min="3000" step="100">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="saveSettings()" style="width: 100%; padding: 1rem;">
                    <i class="fas fa-save"></i> Save Settings
                </button>
                
                <hr style="margin: 2rem 0; border: none; border-top: 1px solid #e2e8f0;">
                
                <h3 style="color: #ef4444; margin-bottom: 1rem;"><i class="fas fa-exclamation-triangle"></i> Danger Zone</h3>
                <button class="btn btn-danger" onclick="clearAllData()">
                    <i class="fas fa-trash"></i> Clear All User Data
                </button>
            </div>
        </div>
    </div>

    <!-- Config MUST load first before any auth functions -->
    <!-- Cache-busting timestamp forces CDN/browser to fetch fresh code -->
    <script src="config.js?t=20250120T150000Z"></script>
    <script src="auth.js?t=20250120T150000Z"></script>
    <script>
        (function () {
            const SESSION_POLL_INTERVAL = 5000;

            function addNoCacheHeaders() {
                const metaTags = [
                    '<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">',
                    '<meta http-equiv="Pragma" content="no-cache">',
                    '<meta http-equiv="Expires" content="0">'
                ];

                metaTags.forEach(tag => {
                    if (!document.head.innerHTML.includes(tag)) {
                        document.head.innerHTML += tag;
                    }
                });
            }

            function enforceSession() {
                // Check for explicit logout first
                if (localStorage.getItem('rtb_logged_out') || sessionStorage.getItem('rtb_logged_out')) {
                    window.location.replace('direct-login.html');
                    return false;
                }
                
                // Get current session
                const sessionData = localStorage.getItem('rtb_auth_session');
                if (!sessionData) {
                    window.location.replace('direct-login.html');
                    return false;
                }
                
                let session;
                try {
                    session = JSON.parse(sessionData);
                } catch (e) {
                    window.location.replace('direct-login.html');
                    return false;
                }
                
                // Check admin role
                if (session.role !== 'admin') {
                    window.location.replace('login.html');
                    return false;
                }

                return true;
            }

            function preventBackNavigation() {
                window.history.pushState(null, null, window.location.href);
                
                window.onpopstate = function() {
                    window.history.pushState(null, null, window.location.href);
                    if (wasExplicitlyLoggedOut()) {
                        window.location.replace('direct-login.html');
                    }
                };
                
                window.onpageshow = function (evt) {
                    if (evt.persisted || wasExplicitlyLoggedOut()) {
                        window.location.replace('direct-login.html');
                    }
                };
            }

            function checkSession() {
                const ok = enforceSession();
                if (!ok) {
                    return;
                }
            }

            addNoCacheHeaders();
            preventBackNavigation();

            (function() {
                const valid = enforceSession();
                if (!valid) {
                    document.body.innerHTML = '<div style="text-align: center; padding: 3rem; font-family: sans-serif;"><h2>Access Denied</h2><p>Redirecting to login page...</p></div>';
                    return;
                }
            })();

            setInterval(checkSession, SESSION_POLL_INTERVAL);

            window.onfocus = function () {
                checkSession();
            };
        })();
    </script>
    <script src="subscription.js"></script>
    <script src="notifications.js"></script>
    <script src="user-registration.js"></script>
    <script>
        let selectedPackage = null;

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
            
            if (sectionId === 'users') loadUsers();
            if (sectionId === 'dashboard') refreshStats();
            if (sectionId === 'settings') loadSettings();
        }

        function selectPackage(price, sessions, schemes) {
            document.querySelectorAll('.package').forEach(p => p.classList.remove('selected'));
            event.target.closest('.package').classList.add('selected');
            selectedPackage = { price, sessions, schemes };
        }

        async function activateUserAccess() {
            if (!selectedPackage) {
                showAlert('activateAlert', 'Please select a package first', 'error');
                return;
            }

            const userId = document.getElementById('userSelect').value;
            if (!userId) {
                showAlert('activateAlert', 'Please select a user first', 'error');
                return;
            }
            
            try {
                // Get user from backend
                const response = await fetch(`${API_BASE}/users/`);
                const allUsers = await response.json();
                const user = allUsers.find(u => u.user_id === userId);
                
                if (!user) {
                    showAlert('activateAlert', 'User not found', 'error');
                    return;
                }
                
                const sessionText = selectedPackage.sessions === 'unlimited' ? 'unlimited session plans' : `${selectedPackage.sessions} session plan${selectedPackage.sessions !== 1 ? 's' : ''}`;
                const schemeText = selectedPackage.schemes === 'unlimited' ? 'unlimited schemes' : `${selectedPackage.schemes} scheme${selectedPackage.schemes !== 1 ? 's' : ''}`;
                
                if (confirm(`Activate ${sessionText} and ${schemeText} for ${user.name}?`)) {
                    // Activate user via backend API
                    const sessionPlans = selectedPackage.sessions === 'unlimited' ? -1 : selectedPackage.sessions;
                    const schemes = selectedPackage.schemes === 'unlimited' ? -1 : selectedPackage.schemes;
                    const activateResponse = await fetch(`${API_BASE}/users/${user.phone}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_plans_limit: sessionPlans,
                            schemes_limit: schemes,
                            is_active: true
                        })
                    });
                    
                    if (activateResponse.ok) {
                        const sessionMsg = selectedPackage.sessions === 'unlimited' ? 'Unlimited Session Plans' : `${selectedPackage.sessions} Session Plan${selectedPackage.sessions !== 1 ? 's' : ''}`;
                        const schemeMsg = selectedPackage.schemes === 'unlimited' ? 'Unlimited Schemes of Work' : `${selectedPackage.schemes} Scheme${selectedPackage.schemes !== 1 ? 's' : ''} of Work`;
                        
                        const message = `Your payment has been successfully received! 🎉\n\nYou now have access to:\n✓ ${sessionMsg}\n✓ ${schemeMsg}\n\nThank you for your purchase!`;
                        
                        showAlert('activateAlert', `User ${user.name} (${user.phone}) activated successfully!`, 'success');
                        
                        // Reset form
                        document.querySelectorAll('.package').forEach(p => p.classList.remove('selected'));
                        selectedPackage = null;
                        document.getElementById('userSelect').value = '';
                        document.getElementById('selectedUserInfo').style.display = 'none';
                        
                        // Refresh stats and users
                        refreshStats();
                        loadUsers();
                    } else {
                        const error = await activateResponse.json();
                        showAlert('activateAlert', `Error activating user: ${error.detail}`, 'error');
                    }
                }
            } catch (error) {
                showAlert('activateAlert', `Error: ${error.message}`, 'error');
            }
        }

        async function sendNotification(e) {
            e.preventDefault();
            const title = document.getElementById('notifTitle').value;
            const message = document.getElementById('notifMessage').value;
            const userSelect = document.getElementById('notifUserSelect').value;
            const notificationType = document.getElementById('notificationType').value;
            
            try {
                let response;
                
                if (userSelect) {
                    // Send to specific user
                    const allUsersResponse = await fetch(`${API_BASE}/users/`);
                    const allUsers = await allUsersResponse.json();
                    const selectedUser = allUsers.find(u => u.user_id === userSelect);
                    
                    if (!selectedUser) {
                        showAlert('notificationAlert', 'Selected user not found', 'error');
                        return;
                    }
                    
                    response = await fetch(`${API_BASE}/notifications/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: selectedUser.id,
                            title: title,
                            message: message,
                            type: notificationType === 'payment' ? 'success' : 'info'
                        })
                    });
                    
                    if (response.ok) {
                        showAlert('notificationAlert', `Notification sent to ${selectedUser.name}!`, 'success');
                    } else {
                        const error = await response.json();
                        showAlert('notificationAlert', `Error: ${error.detail}`, 'error');
                    }
                } else {
                    // Send to all users (bulk notification)
                    response = await fetch(`${API_BASE}/notifications/bulk`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: title,
                            message: message,
                            type: notificationType === 'payment' ? 'success' : 'info'
                        })
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        showAlert('notificationAlert', result.message, 'success');
                    } else {
                        const error = await response.json();
                        showAlert('notificationAlert', `Error: ${error.detail}`, 'error');
                    }
                }
                
                // Reset form on success
                if (response.ok) {
                    e.target.reset();
                }
                
            } catch (error) {
                showAlert('notificationAlert', `Network error: ${error.message}`, 'error');
            }
        }

        async function loadUsers() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">Loading users from database...</p>';
            
            try {
                // Fetch users from backend API with retry mechanism
                let allUsers = [];
                let retryCount = 0;
                const maxRetries = 3;
                
                while (retryCount < maxRetries) {
                    try {
                        const response = await fetch(`${API_BASE}/users/`, {
                            method: 'GET',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            },
                            cache: 'no-store'
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}`);
                        }
                        
                        allUsers = await response.json();
                        console.log('Loaded users from backend:', allUsers.length, allUsers);
                        break; // Success, exit retry loop
                    } catch (fetchError) {
                        retryCount++;
                        if (retryCount >= maxRetries) {
                            throw fetchError; // Rethrow after max retries
                        }
                        console.log(`Retry ${retryCount}/${maxRetries} loading users...`);
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 second before retry
                    }
                }
                
                // Ensure we have the default admin if no users are found
                if (allUsers.length === 0) {
                    // Add default admin to the list
                    allUsers = [{
                        user_id: 'ADMIN_DEFAULT',
                        name: 'Administrator',
                        phone: '+250789751597',
                        email: 'admin@rtb.rw',
                        institution: 'RTB',
                        role: 'admin',
                        is_premium: true,
                        session_plans_limit: 999,
                        schemes_limit: 999,
                        session_plans_downloaded: 0,
                        schemes_downloaded: 0,
                        created_at: new Date().toISOString()
                    }];
                }
                
                if (allUsers.length === 0) {
                    userList.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No registered users yet</p>';
                    return;
                }
                
                userList.innerHTML = allUsers.map(user => {
                    const isPremium = user.is_premium ? '<span style="color: #10b981; font-weight: bold;">PREMIUM</span>' : '<span style="color: #64748b;">FREE</span>';
                    const role = user.role === 'admin' ? '<span style="color: #ef4444; font-weight: bold;">[ADMIN]</span>' : '';
                    
                    // Handle missing or undefined values
                    const name = user.name || 'Unknown User';
                    const phone = user.phone || 'No Phone';
                    const institution = user.institution || 'No Institution';
                    const sessionPlansDownloaded = user.session_plans_downloaded || 0;
                    const sessionPlansLimit = user.session_plans_limit || 0;
                    const schemesDownloaded = user.schemes_downloaded || 0;
                    const schemesLimit = user.schemes_limit || 0;
                    const createdAt = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Unknown';
                    
                    return `
                    <div class="user-item" data-user-search="${name.toLowerCase()} ${phone} ${institution.toLowerCase()}">
                        <div class="user-info">
                            <div class="user-id">
                                <i class="fas fa-user-circle" style="color: #6366f1;"></i> ${name} ${isPremium} ${role}
                            </div>
                            <div class="user-stats">
                                <i class="fas fa-phone"></i> ${phone} | 
                                <i class="fas fa-school"></i> ${institution}<br>
                                <small style="color: #94a3b8;">Plans: ${sessionPlansDownloaded}/${sessionPlansLimit} | Schemes: ${schemesDownloaded}/${schemesLimit}</small><br>
                                <small style="color: #94a3b8;">Registered: ${createdAt}</small>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="viewUserDetails('${user.user_id}')">
                            <i class="fas fa-eye"></i> Details
                        </button>
                    </div>
                `}).join('');
                
                // Populate user selects
                populateUserSelects(allUsers);
                
            } catch (error) {
                console.error('Error loading users:', error);
                userList.innerHTML = `
                    <p style="color: #ef4444; text-align: center; padding: 2rem;">
                        Error loading users: ${error.message}<br>
                        Make sure backend is running on port 8000
                    </p>
                    <button class="btn btn-primary" style="margin: 0 auto; display: block;" onclick="loadUsers()">
                        <i class="fas fa-sync"></i> Retry Loading Users
                    </button>
                `;
            }
        }
        
        function filterUsers() {
            const search = document.getElementById('searchUser').value.toLowerCase();
            document.querySelectorAll('.user-item').forEach(item => {
                const searchText = item.getAttribute('data-user-search');
                item.style.display = searchText.includes(search) ? 'flex' : 'none';
            });
        }
        
        function populateUserSelects(users) {
            const activateSelect = document.getElementById('userSelect');
            const notifSelect = document.getElementById('notifUserSelect');
            
            console.log('Populating selects with users:', users);
            
            const options = users.map(u => 
                `<option value="${u.user_id}">${u.name} - ${u.phone}</option>`
            ).join('');
            
            activateSelect.innerHTML = '<option value="">-- Select a user --</option>' + options;
            notifSelect.innerHTML = '<option value="">All Users (Broadcast)</option>' + options;
            
            // Remove old listeners
            const newSelect = activateSelect.cloneNode(true);
            activateSelect.parentNode.replaceChild(newSelect, activateSelect);
            
            // Show user info on selection
            document.getElementById('userSelect').addEventListener('change', function() {
                const userId = this.value;
                console.log('Selected user ID:', userId);
                if (userId) {
                    const user = users.find(u => u.user_id === userId);
                    console.log('Found user:', user);
                    if (user) {
                        const premiumStatus = user.is_premium ? 'Premium User' : 'Free User';
                        document.getElementById('userInfoDisplay').innerHTML = `
                            <strong>${user.name}</strong> (${premiumStatus})<br>
                            Phone: ${user.phone}<br>
                            Institution: ${user.institution}<br>
                            Email: ${user.email || 'Not provided'}<br>
                            Session Plans: ${user.session_plans_downloaded}/${user.session_plans_limit}<br>
                            Schemes: ${user.schemes_downloaded}/${user.schemes_limit}
                        `;
                        document.getElementById('selectedUserInfo').style.display = 'block';
                    }
                } else {
                    document.getElementById('selectedUserInfo').style.display = 'none';
                }
            });
        }



        async function viewUserDetails(userId) {
            try {
                const response = await fetch(`${API_BASE}/users/`);
                const allUsers = await response.json();
                const user = allUsers.find(u => u.user_id === userId);
                
                if (!user) {
                    alert('User not found');
                    return;
                }
                
                const premiumStatus = user.is_premium ? 'Premium User' : 'Free User';
                alert(`User Details:\n\nName: ${user.name}\nPhone: ${user.phone}\nEmail: ${user.email || 'Not provided'}\nInstitution: ${user.institution}\nRole: ${user.role}\nStatus: ${premiumStatus}\nSession Plans: ${user.session_plans_downloaded}/${user.session_plans_limit}\nSchemes: ${user.schemes_downloaded}/${user.schemes_limit}\nRegistered: ${new Date(user.created_at).toLocaleString()}\n\nUser ID: ${user.user_id}`);
            } catch (error) {
                alert('Error loading user details: ' + error.message);
            }
        }

        async function refreshStats() {
            try {
                const [usersRes, statsRes] = await Promise.all([
                    fetch(`${API_BASE}/users/`),
                    fetch(`${API_BASE}/stats`)
                ]);
                
                const users = usersRes.ok ? await usersRes.json() : [];
                const stats = statsRes.ok ? await statsRes.json() : {};
                
                document.getElementById('totalUsers').textContent = stats.total_users || users.length;
                document.getElementById('premiumUsers').textContent = stats.premium_users || users.filter(u => u.is_premium).length;
                document.getElementById('totalSessionPlans').textContent = stats.total_downloads || 0;
                document.getElementById('totalSchemes').textContent = stats.total_downloads || 0;
            } catch (error) {
                console.error('Error fetching stats:', error);
                document.getElementById('totalUsers').textContent = 'Error';
                document.getElementById('premiumUsers').textContent = 'Error';
                document.getElementById('totalSessionPlans').textContent = 'Error';
                document.getElementById('totalSchemes').textContent = 'Error';
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch(`${API_BASE}/settings`);
                if (response.ok) {
                    const settings = await response.json();
                    document.getElementById('freeSessionPlans').value = settings.free_session_plans || 2;
                    document.getElementById('freeSchemes').value = settings.free_schemes || 2;
                    document.getElementById('perSessionPrice').value = settings.per_session_price || 36;
                    document.getElementById('perSchemePrice').value = settings.per_scheme_price || 47;
                    document.getElementById('weeklySessionsPrice').value = settings.weekly_sessions_price || 474;
                    document.getElementById('weeklySchemesPrice').value = settings.weekly_schemes_price || 526;
                    document.getElementById('monthlySessionsPrice').value = settings.monthly_sessions_price || 1000;
                    document.getElementById('monthlySchemesPrice').value = settings.monthly_schemes_price || 1889;
                    document.getElementById('unlimitedPrice').value = settings.unlimited_price || 5200;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        async function saveSettings() {
            try {
                const settings = {
                    free_session_plans: parseInt(document.getElementById('freeSessionPlans').value),
                    free_schemes: parseInt(document.getElementById('freeSchemes').value),
                    per_session_price: parseInt(document.getElementById('perSessionPrice').value),
                    per_scheme_price: parseInt(document.getElementById('perSchemePrice').value),
                    weekly_sessions_price: parseInt(document.getElementById('weeklySessionsPrice').value),
                    weekly_schemes_price: parseInt(document.getElementById('weeklySchemesPrice').value),
                    monthly_sessions_price: parseInt(document.getElementById('monthlySessionsPrice').value),
                    monthly_schemes_price: parseInt(document.getElementById('monthlySchemesPrice').value),
                    unlimited_price: parseInt(document.getElementById('unlimitedPrice').value)
                };
                
                const response = await fetch(`${API_BASE}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                if (response.ok) {
                    showAlert('settingsAlert', 'Settings saved successfully!', 'success');
                } else {
                    showAlert('settingsAlert', 'Error saving settings', 'error');
                }
            } catch (error) {
                showAlert('settingsAlert', 'Network error: ' + error.message, 'error');
            }
        }

        function clearAllData() {
            if (confirm('⚠️ This will delete ALL user data! Are you sure?')) {
                if (confirm('This action cannot be undone. Continue?')) {
                    localStorage.clear();
                    alert('All data cleared successfully!');
                    refreshStats();
                    loadUsers();
                }
            }
        }

        function loadNotificationTemplate() {
            const type = document.getElementById('notificationType').value;
            const titleField = document.getElementById('notifTitle');
            const messageField = document.getElementById('notifMessage');
            
            const templates = {
                payment: {
                    title: "Payment Received - Access Activated! 🎉",
                    message: "Your payment has been successfully received!\n\nYou now have access to:\n✓ Additional Session Plans\n✓ Additional Schemes of Work\n\nThank you for your purchase! Start creating your documents now."
                },
                welcome: {
                    title: "Welcome to RTB Document Planner! 🎓",
                    message: "Welcome to the RTB Document Planner system!\n\nYou can now:\n✓ Create professional session plans\n✓ Generate schemes of work\n✓ Download RTB-compliant documents\n\nGet started by visiting the main dashboard."
                },
                session_plan: {
                    title: "New Session Plan Available 📋",
                    message: "A new session plan has been created and is ready for download.\n\nYou can now:\n✓ Download the document\n✓ Use it for your classes\n✓ Print or share as needed\n\nCheck your dashboard to access it."
                },
                scheme_ready: {
                    title: "Scheme of Work Ready 📚",
                    message: "Your scheme of work has been generated successfully!\n\nThe document includes:\n✓ Complete curriculum structure\n✓ Learning outcomes\n✓ Assessment details\n✓ RTB-compliant formatting\n\nDownload it from your dashboard."
                },
                subscription: {
                    title: "Subscription Updated 🔄",
                    message: "Your subscription has been updated successfully!\n\nNew limits:\n✓ Session Plans: [SPECIFY NUMBER]\n✓ Schemes of Work: [SPECIFY NUMBER]\n\nYour updated access is now active."
                },
                reminder: {
                    title: "Subscription Reminder 💳",
                    message: "Your current subscription is running low.\n\nRemaining:\n• Session Plans: [SPECIFY NUMBER]\n• Schemes of Work: [SPECIFY NUMBER]\n\nContact admin to renew your subscription and continue creating documents."
                },
                announcement: {
                    title: "System Announcement 📢",
                    message: "Important system update:\n\n[SPECIFY ANNOUNCEMENT]\n\nIf you have any questions, please contact the administrator."
                },
                custom: {
                    title: "",
                    message: ""
                }
            };
            
            const template = templates[type] || templates.custom;
            titleField.value = template.title;
            messageField.value = template.message;
        }
        
        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.textContent = message;
            alert.className = `alert ${type} show`;
            setTimeout(() => alert.classList.remove('show'), 5000);
        }

        // Initialize
        const session = getCurrentSession();
        if (session) {
            document.getElementById('adminName').innerHTML = `<i class="fas fa-user-shield"></i> ${session.name}`;
        }
        
        // Load initial data
        refreshStats();
        loadUsers();
        
        // Set up auto-refresh for data
        setInterval(function() {
            if (document.getElementById('users').classList.contains('active')) {
                loadUsers();
            }
            if (document.getElementById('dashboard').classList.contains('active')) {
                refreshStats();
            }
        }, 60000); // Refresh every minute
        
        // Add event listener for visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                // Page is now visible, refresh data
                refreshStats();
                if (document.getElementById('users').classList.contains('active')) {
                    loadUsers();
                }
            }
        });
    </script>
</body>
</html>
